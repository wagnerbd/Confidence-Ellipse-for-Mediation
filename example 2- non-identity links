data Ex3;
   input ID A M Y nY offset @@ ;
   datalines;
1 1 28 100 112 4.718 	2 0 28 34 34 3.526 	3 0 11 12 98 4.585
4 1 28 76 112 4.718 	5 0 10 49 112 4.718 	6 0 8 6 112 4.718 
7 1 28 26 109 4.691 	8 0 28 21 21 3.045 	9 0 23 30 105 4.654 
10 0 28 71 112 4.718 	11 1 1 0 112 4.718 	12 0 1 0 7 1.946 
13 0 10 31 111 4.710 	14 0 9 28 112 4.718 	15 1 19 89 112 4.718 
16 0 5 7 112 4.718 	17 1 14 62 105 4.654 	18 0 13 49 112 4.718 
19 0 4 21 112 4.718 	20 0 3 0 112 4.718 	21 0 17 6 28 3.332 
22 1 0 0 112 4.718 	23 0 2 7 112 4.718 	24 0 0 0 91 4.511 
25 1 16 26 112 4.718 	26 0 23 2 109 4.691 	27 1 6 17 108 4.682 
28 1 28 11 21 3.045 	29 1 28 32 56 4.025 	30 1 27 101 112 4.718 
31 1 16 60 112 4.718 	32 0 3 0 112 4.718 	33 1 10 91 112 4.718 
34 0 25 76 111 4.710 	35 0 23 72 77 4.344 	36 0 28 98 107 4.673 
37 1 15 0 111 4.710 	38 1 27 52 56 4.025 	39 0 28 21 112 4.718 
40 0 13 18 112 4.718 	41 0 10 8 112 4.718 	42 1 3 0 112 4.718 
43 1 3 1 111 4.710 	44 0 17 4 112 4.718 	45 1 28 44 111 4.710 
46 0 23 108 111 4.710 	47 0 15 22 103 4.635 	48 0 15 2 112 4.718 
49 1 3 87 112 4.718 	50 1 4 0 21 3.045 	51 0 24 86 109 4.691 
52 1 5 49 105 4.654 	53 1 5 29 112 4.718 	54 1 16 51 105 4.654 
55 1 26 11 111 4.710 	56 0 13 26 112 4.718 	57 0 28 92 107 4.673 
58 0 11 44 96 4.564 	59 0 18 32 112 4.718 	60 0 1 0 14 2.639 
61 0 3 44 112 4.718 	62 0 14 17 63 4.143 	63 0 11 9 84 4.431 
64 0 22 59 112 4.718 	65 0 18 10 106 4.663 	66 0 26 31 42 3.738 
67 0 9 3 112 4.718 	68 0 26 60 106 4.663 	69 1 6 78 107 4.673 
70 0 22 6 112 4.718 	71 0 11 0 112 4.718 	72 0 12 9 86 4.454 
73 0 11 9 42 3.738 	74 0 1 20 112 4.718 	75 0 12 20 106 4.663 
76 0 15 43 98 4.585 	77 0 4 16 110 4.700 	78 0 28 84 112 4.718 
79 1 15 47 97 4.575 	80 0 28 16 112 4.718 	81 0 21 72 112 4.718 
82 0 13 4 84 4.431 	83 0 19 13 111 4.710 	84 0 5 21 112 4.718 
85 0 28 34 77 4.344 	86 0 11 21 105 4.654 	87 1 13 106 110 4.700 
88 0 13 61 112 4.718 	89 1 6 8 42 3.738 	90 0 1 15 112 4.718 
91 0 11 21 111 4.710 	92 0 7 13 108 4.682 	93 0 9 11 111 4.710 
94 0 5 46 112 4.718 	95 0 23 60 112 4.718 	96 1 14 13 21 3.045 
97 1 28 5 35 3.555 	98 0 28 10 112 4.718 	99 0 3 11 112 4.718 
100 0 28 23 112 4.718 	101 1 3 5 111 4.710 	102 0 28 66 109 4.691 
103 0 2 0 112 4.718 	104 0 1 7 112 4.718 	105 0 1 1 109 4.691 
106 0 12 0 112 4.718 	107 1 28 56 108 4.682 	108 0 6 1 112 4.718 
109 0 14 21 63 4.143 	110 1 24 20 112 4.718 	111 0 4 5 111 4.710 
112 0 11 0 109 4.691 	113 1 17 7 112 4.718 	114 0 19 25 105 4.654 
115 0 1 2 91 4.511 	116 0 17 48 107 4.673 	117 0 28 57 112 4.718 
118 1 8 88 112 4.718 	119 1 21 98 111 4.710 	120 1 20 43 112 4.718 
121 1 24 58 112 4.718 	122 0 23 0 105 4.654 	123 0 3 57 111 4.710 
124 0 9 13 110 4.700 	125 0 2 2 28 3.332 	126 0 5 1 112 4.718 
127 0 4 1 112 4.718 	128 0 1 0 112 4.718 	129 1 21 101 111 4.710 
130 0 28 50 112 4.718 	131 1 24 108 112 4.718 	132 1 23 14 112 4.718 
133 1 19 9 98 4.585 	134 0 19 18 112 4.718 	135 1 21 38 112 4.718 
136 1 28 53 107 4.673 	137 0 21 2 28 3.332 	138 0 4 6 112 4.718 
139 0 17 27 112 4.718 	140 1 22 94 111 4.710 	141 0 12 56 112 4.718 
142 0 26 53 112 4.718 	143 0 12 5 98 4.585 	144 0 21 37 111 4.710 
145 0 12 7 35 3.555 	146 1 2 1 112 4.718 	147 1 27 35 63 4.143 
148 0 14 23 112 4.718 	149 0 8 0 112 4.718 	150 1 26 28 91 4.511 
151 1 22 63 112 4.718 	152 0 10 25 105 4.654 	153 0 1 22 111 4.710 
154 0 11 6 104 4.644 	155 0 28 24 56 4.025 	156 0 28 111 112 4.718 
157 0 3 16 98 4.585 	158 1 12 53 105 4.654 	159 0 12 32 112 4.718 
160 0 28 58 112 4.718 	161 0 10 1 112 4.718 	162 0 22 11 112 4.718 
163 0 25 51 112 4.718 	164 1 8 7 21 3.045 	165 1 3 40 112 4.718 
166 0 28 54 77 4.344 	167 1 4 3 105 4.654 	168 1 24 92 111 4.710 
169 0 1 10 28 3.332 	170 1 8 27 112 4.718 	171 0 22 22 35 3.555 
172 1 28 34 49 3.892 	173 1 16 0 105 4.654 	174 0 4 0 105 4.654 
175 0 2 0 112 4.718 	176 0 23 7 106 4.663 	177 1 27 41 42 3.738 
178 0 5 6 108 4.682 	179 0 26 30 112 4.718 	180 1 12 1 35 3.555 
181 0 7 6 112 4.718 	182 0 19 0 112 4.718 	183 0 1 1 21 3.045 
184 0 12 35 112 4.718 	185 0 3 7 112 4.718 	186 0 5 21 107 4.673 
187 0 28 10 112 4.718 	188 1 18 2 14 2.639 	189 0 27 20 107 4.673 
190 1 28 58 112 4.718 	191 0 2 2 112 4.718 	192 0 2 4 49 3.892 
193 0 28 0 7 1.946 	194 1 2 13 112 4.718 	195 1 28 77 110 4.700 
196 0 8 18 112 4.718 	197 1 14 51 112 4.718 	198 1 2 3 112 4.718 
199 0 9 8 105 4.654 	200 0 15 43 112 4.718 	201 0 9 41 105 4.654 
202 0 11 39 49 3.892 	203 0 21 17 91 4.511 	204 1 28 88 98 4.585 
205 0 16 31 109 4.691 	206 0 9 0 112 4.718 	207 0 14 0 7 1.946 
208 0 28 14 14 2.639 	209 0 28 99 112 4.718 	210 0 28 103 105 4.654 
211 0 7 0 112 4.718 	212 0 11 7 91 4.511 	213 0 7 67 112 4.718 
214 0 12 0 112 4.718 	215 0 21 9 112 4.718 	216 0 4 15 112 4.718 
217 0 8 1 35 3.555 	218 0 3 7 103 4.635 	219 1 6 0 112 4.718 
220 1 27 63 112 4.718 	221 0 1 3 112 4.718 	222 1 9 3 28 3.332 
223 1 4 7 112 4.718 	224 0 10 89 112 4.718 	225 1 11 17 110 4.700 	
226 1 14 19 112 4.718 	227 0 10 10 112 4.718 	228 1 28 82 112 4.718 
229 1 12 22 105 4.654 	230 0 21 46 112 4.718 	231 0 4 0 111 4.710 
232 0 6 14 112 4.718 	233 0 28 38 112 4.718 	234 0 24 7 112 4.718 
235 0 28 70 110 4.700 	236 1 27 75 112 4.718 	237 1 6 20 112 4.718 
238 0 11 4 112 4.718 	239 1 2 0 35 3.555 	240 1 18 72 109 4.691 
241 0 24 57 112 4.718 	242 1 1 89 112 4.718 	243 1 26 65 112 4.718 
244 0 18 12 112 4.718 	245 1 24 5 7 1.946 	246 0 1 0 70 4.248 
247 0 1 3 112 4.718 	248 0 1 5 112 4.718 	249 0 23 49 112 4.718 
250 1 24 109 112 4.718 	251 0 15 84 112 4.718 	252 0 8 16 84 4.431 
253 1 28 98 105 4.654 	254 1 28 34 112 4.718 	255 1 18 19 112 4.718 
256 0 16 1 92 4.522 	257 1 10 16 112 4.718 	258 1 20 89 112 4.718 
259 0 5 101 112 4.718 	260 1 7 2 70 4.248 	261 0 4 15 112 4.718 
262 0 1 0 112 4.718 	263 0 2 0 112 4.718 	264 0 10 5 112 4.718 
265 1 21 3 35 3.555 	266 0 3 0 112 4.718 	267 0 18 1 112 4.718 
268 0 12 0 105 4.654 	269 0 23 22 112 4.718 	270 1 28 20 112 4.718 
271 0 26 0 105 4.654 	272 0 2 6 112 4.718 	273 0 28 76 98 4.585 
274 0 25 12 112 4.718 	275 0 1 7 112 4.718 	276 0 26 52 77 4.344 
277 0 14 73 112 4.718 	278 0 10 27 112 4.718 	279 0 5 1 112 4.718 
280 0 8 0 112 4.718 	281 1 5 0 77 4.344 	282 0 1 2 56 4.025 
283 0 3 8 112 4.718 	284 0 7 0 77 4.344 	285 0 17 0 77 4.344 
286 0 25 1 112 4.718 	287 0 16 30 112 4.718 	288 0 10 2 112 4.718 
289 1 28 67 112 4.718 	290 0 28 85 98 4.585 	291 1 13 7 49 3.892 
292 1 2 3 112 4.718 	293 0 8 27 112 4.718 	294 0 8 5 35 3.555 
295 0 8 0 112 4.718 	296 1 28 71 112 4.718 	297 0 3 1 105 4.654 
;
run; 

proc sort data=Ex3;  by id;  
proc freq data=Ex3;
	table id/ out=sub;
run;
proc means data=sub;
	var id;
	output out=numsub n=numsub;
run;
data _NULL_;
	set numsub;
	call symput('n', numsub);
run;
%put &n;

/*confidence ellipse for NIE*/
proc nlmixed data=Ex3 ecov;
   parms t0=-1.5 t1=1.8 t2=0 b0=1 b1=-.4  k=1 j=1;  
* Conditional distribution of M given A;
      mu_m =b0 + b1*A;
      ll_m= lgamma(M +1/j) -lgamma(M+1) -lgamma(1/j) + M*log(j*exp(mu_m)) - (M+ 1/j)*log(1 + j*exp(mu_m));
* Conditional distribution of Y given M and A;
        mu_y=t0 + t1*A + t2*M + ln_y;
        ll_y= lgamma(Y +1/k) -lgamma(Y+1) -lgamma(1/k) + Y*log(k*exp(mu_y)) - (Y+ 1/k)*log(1 + k*exp(mu_y));
* Add log likelihoods of M and Y;
      ll_o= ll_m + ll_y;
    model Y ~general(ll_o);  *  Z is not used in the model statement, but must not be missing.  Y and M2 have missing values;
      estimate 'B1' B1 ;                   
      estimate 'T2' T2 ;
	ods output AdditionalEstimates = AdditionalEstimates
           CovMatAddEst      = CovMatAddEst;
run;
title ' Simultaneous 95% Confidence Limits for B1, T2, and the NIE Based on 95% Confidence Ellipse';
%confidence_ellipseNIE (AdditionalEstimates, CovMatAddEst, 0.05, Ellipse1, 'log', 'log', 2.6, 1, 0); 

proc sort data=Ellipse1;  by B1;
title ' Simultaneous 95% Confidence Limits for B1 and T2 Based on 95% Confidence Ellipse';
 proc gplot data=Ellipse1;
   plot   minminT2*B1=1 maxmaxT2*B1=1 minT2*B1=2 maxT2*B1=2 T2*B1=3 / overlay      
   vaxis=axis1 haxis=axis2 vref=0 href=0;
   axis1 label=(a=90 h=4 f=cgreek 'q' h=2 f=zapf '2') minor=none value=(h=1.5) order=(0 to 0.1 by 0.025);  
	axis2 label=(h=4 f=cgreek 'b' h=2 f=zapf '1') minor=none value=(h=1.5);
   symbol1 i=j line=1 color=red w=2 ;
   symbol2 i=j line=1 color=blue w=2 l=22;
   symbol3 i=hilo line=1 color=red w=2;
 run;
